<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.15">
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-8HZFMZV9Z4"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-8HZFMZV9Z4",{anonymize_ip:!0})</script><title data-react-helmet="true">Advanced Text Manipulation | Effective Shell</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://effective-shell.com/part-3-manipulating-text/advanced-text-manipulation/"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Advanced Text Manipulation | Effective Shell"><meta data-react-helmet="true" name="description" content="In Chapter 15 we introduced some simple commands to work with text - specifically head, tail, tr and cut. Now we are going to introduce sed the Stream Editor command."><meta data-react-helmet="true" property="og:description" content="In Chapter 15 we introduced some simple commands to work with text - specifically head, tail, tr and cut. Now we are going to introduce sed the Stream Editor command."><link data-react-helmet="true" rel="icon" href="/img/favicon.png"><link data-react-helmet="true" rel="canonical" href="https://effective-shell.com/part-3-manipulating-text/advanced-text-manipulation/"><link data-react-helmet="true" rel="alternate" href="https://effective-shell.com/part-3-manipulating-text/advanced-text-manipulation/" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://effective-shell.com/part-3-manipulating-text/advanced-text-manipulation/" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.078694be.css">
<link rel="preload" href="/assets/js/runtime~main.c9e750a8.js" as="script">
<link rel="preload" href="/assets/js/main.feaa3aec.js" as="script">
</head>
<body data-theme="light">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.png" alt="Effective Shell Logo" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/img/logo.png" alt="Effective Shell Logo" class="themedImage_W2Cr themedImage--dark_oUvU"></div><b class="navbar__title">Effective Shell</b></a><a class="navbar__item navbar__link navbar__link--active" href="/">Home</a></div><div class="navbar__items navbar__items--right"><div class="toggle_Pssr toggle_TdHA toggleDisabled_jDku"><div class="toggleTrack_SSoT" role="button" tabindex="-1"><div class="toggleTrackCheck_XobZ"><span class="toggleIcon_eZtF">ðŸŒœ</span></div><div class="toggleTrackX_YkSC"><span class="toggleIcon_eZtF">ðŸŒž</span></div><div class="toggleTrackThumb_uRm4"></div></div><input type="checkbox" class="toggleScreenReader_JnkT" aria-label="Switch between dark and light mode"></div><div class="dsla-search-wrapper"><div class="dsla-search-field" data-tags="default,docs-default-current"></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_P2Lg"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_RiI4" type="button"></button><aside class="theme-doc-sidebar-container docSidebarContainer_rKC_"><div class="sidebar_CW9Y"><nav class="menu thin-scrollbar menu_SkdO"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/">Effective Shell</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link hasHref_VCh3" href="/part-1-transitioning-to-the-shell/">Transitioning to the Shell</a><button aria-label="Toggle the collapsible sidebar category &#x27;Transitioning to the Shell&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link hasHref_VCh3" href="/part-2-core-skill/">Core Skills</a><button aria-label="Toggle the collapsible sidebar category &#x27;Core Skills&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--active hasHref_VCh3" aria-current="page" href="/part-3-manipulating-text/">Manipulating Text and Streams</a><button aria-label="Toggle the collapsible sidebar category &#x27;Manipulating Text and Streams&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/part-3-manipulating-text/regex-essentials/">Regex Essentials</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/part-3-manipulating-text/get-to-grips-with-grep/">Get to Grips with Grep</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/part-3-manipulating-text/slice-and-dice-text/">Slice and Dice Text</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/part-3-manipulating-text/advanced-text-manipulation/">Advanced Text Manipulation</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/part-3-manipulating-text/build-commands-on-the-fly/">Build Commands on the Fly</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link hasHref_VCh3" href="/part-4-shell-scripting/">Shell Scripting</a><button aria-label="Toggle the collapsible sidebar category &#x27;Shell Scripting&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link hasHref_VCh3" href="/part-5-building-your-toolkit/">Building Your Toolkit</a><button aria-label="Toggle the collapsible sidebar category &#x27;Building Your Toolkit&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link hasHref_VCh3" href="/part-6-advanced-techniques/">Advanced Techniques</a><button aria-label="Toggle the collapsible sidebar category &#x27;Advanced Techniques&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></aside><main class="docMainContainer_TCnq"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_DM6M"><div class="docItemContainer_vinB"><article><div class="tocCollapsible_jdIR theme-doc-toc-mobile tocMobile_TmEX"><button type="button" class="clean-btn tocCollapsibleButton_Fzxq">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Advanced Text Manipulation</h1></header><p>In <a href="/part-3-manipulating-text/slice-and-dice-text">Chapter 15</a> we introduced some simple commands to work with text - specifically <code>head</code>, <code>tail</code>, <code>tr</code> and <code>cut</code>. Now we are going to introduce <code>sed</code> the <em>Stream Editor</em> command. </p><p><code>sed</code> can be used to perform a variety of tasks with text. In many cases a small command involving <code>sed</code> can quickly solve problems. We&#x27;ll look at some of the common ways to use <code>sed</code>, some more sophisticated examples and discuss when you might want to consider using alternative tools like <code>awk</code> or a programming language.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="introducing-the-stream-editor">Introducing the Stream Editor<a class="hash-link" href="#introducing-the-stream-editor" title="Direct link to heading">â€‹</a></h2><p>The stream editor command takes input from a <em>stream</em> - which in many cases will simply be a file. It then performs operations on the text as it is read, and writes the output to <code>stdout</code>. This command is <em>extremely</em> powerful - there are many sophisticated transformations which can be applied.</p><p>Seeing <code>sed</code> commands can be a little intimidating - they can look complex! But we&#x27;ll start with the basics and hopefully you&#x27;ll see just how effective this tool can make you!</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="transformations-with-sed">Transformations with Sed<a class="hash-link" href="#transformations-with-sed" title="Direct link to heading">â€‹</a></h2><p>Rather than dissecting each and every option or flag and every nuance of the program, I&#x27;m going to try and show some real world examples of how you can use <code>sed</code>. This will allow us to see the functionality in easier to digest chunks. It also keeps things practical! Let&#x27;s dive in and look at some common tasks and how we can solve them with <code>sed</code>.</p><div class="admonition admonition-tip alert alert--success"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Downloading the Samples</h5></div><div class="admonition-content"><p>Run the following command in your shell to download the samples:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> effective.sh </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">sh</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="replacing-text">Replacing Text<a class="hash-link" href="#replacing-text" title="Direct link to heading">â€‹</a></h3><p>The samples folder has a script which copies some configuration files to a backup folder. Let&#x27;s take a quick look at it:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ cd scripts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ cat backup-config.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#!/usr/bin/env bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Make sure we have a backup directory.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mkdir ~/backup</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Copy over alicloud, aws, azure, gcp and ssh config and credentials.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cp ~/.aliyun/config.json ~/backup/settings/aliyun/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cp ~/.aws/config ~/backup/settings/aws/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cp ~/.aws/credentials ~/backup/settings/aws/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cp ~/.azure/config ~/backup/settings/azure/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cp ~/.config/gcloud/credentials.db ~/backup/settings/gcloud/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cp ~/.ssh/config ~/backup/settings/ssh/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cp ~/.ssh/id_rsa ~/backup/settings/ssh/ # is this safe?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cp ~/.ssh/id_rsa.pub ~/backup/settings/ssh/</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>We could use the <code>sed</code> command to change the name of the folder we backup to. If we wanted to change the <code>settings</code> folder to <code>configuration</code> we could run the command below:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ sed &#x27;s/settings/configuration/&#x27; backup-config.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#!/usr/bin/env bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Copy over alicloud, aws, azure, gcp and ssh config and credentials.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cp ~/.aliyun/config.json ~/backup/configuration/aliyun/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cp ~/.aws/config ~/backup/configuration/aws/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cp ~/.aws/credentials ~/backup/configuration/aws/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cp ~/.azure/config ~/backup/configuration/azure/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cp ~/.config/gcloud/credentials.db ~/backup/configuration/gcloud/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cp ~/.ssh/config ~/backup/configuration/ssh/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cp ~/.ssh/id_rsa ~/backup/configuration/ssh/ # is this safe?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cp ~/.ssh/id_rsa.pub ~/backup/configuration/ssh/</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>This shows the basics of how <code>sed</code> works. We give <code>sed</code> an <em>expression</em>, which describes a set of operations we want to perform and it then applies that expression to the file we specify. As with most commands we&#x27;ve seen it can apply the expression to <code>stdin</code>.</p><p>Let&#x27;s look at the expression in detail:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">s/settings/dotfiles/</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><ul><li>The <code>s</code> indicates that we are going to run the <em>substitute</em> function, which is used to replace text</li><li>The <code>/</code> indicates the start of the <em>pattern</em> we are searching for...</li><li>...<code>settings</code> is the pattern - which is just the literal text &#x27;settings&#x27;</li><li>The second <code>/</code> indicates the start of the <em>replacement</em> we will make when the <em>pattern</em> is found</li><li>The final <code>/</code> indicates the end of the replacement - we can also optionally put <em>flags</em> after this slash</li></ul><p>Just as we saw in <a href="/part-3-manipulating-text/get-to-grips-with-grep">Chapter 13 - Get to Grips with Grep</a>, we can provide a <em>regular expression</em> as the pattern to search for. By default, <code>sed</code> will use <em>basic</em> regular expressions. We can use <em>extended regular expressions</em> by providing the <code>-E</code> flag.</p><div class="admonition admonition-tip alert alert--success"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Basic and Extended Regular Expressions</h5></div><div class="admonition-content"><p>If you are not sure about the difference between Basic and Extended Regular Expressions, you can use the:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">man re_pattern</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Command to get detailed documentation.</p></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="applying-multiple-expressions">Applying Multiple Expressions<a class="hash-link" href="#applying-multiple-expressions" title="Direct link to heading">â€‹</a></h3><p>We can use the <code>-e &lt;expression&gt;</code> flag to supply multiple expressions to <code>sed</code>.</p><p>If we wanted to delete our backup folders, we could run two substitutions - one which changes the <code>cp</code> command to <code>rmdir</code> command and one which deletes the first parameter, which was the source directory for <code>cp</code> but is not needed for <code>rmdir</code><sup id="fnref-1"><a href="#fn-1" class="footnote-ref">1</a></sup>.</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="replacing-text-on-specific-lines">Replacing Text on Specific Lines<a class="hash-link" href="#replacing-text-on-specific-lines" title="Direct link to heading">â€‹</a></h4><p>Let&#x27;s start with the first expression, which should change <code>cp</code> to <code>rmdir</code>:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ sed -e &#x27;s/cp/rmdir/&#x27; backup-config.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#!/usr/bin/env bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Make sure we have a backup directory.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mkdir ~/backup</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Copy over alicloud, aws, azure, grmdir and ssh config and credentials.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rmdir ~/.aliyun/config.json ~/backup/settings/aliyun/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rmdir ~/.aws/config ~/backup/settings/aws/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rmdir ~/.aws/credentials ~/backup/settings/aws/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rmdir ~/.azure/config ~/backup/settings/azure/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rmdir ~/.config/gcloud/credentials.db ~/backup/settings/gcloud/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rmdir ~/.ssh/config ~/backup/settings/ssh/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rmdir ~/.ssh/id_rsa ~/backup/settings/ssh/ # is this safe?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rmdir ~/.ssh/id_rsa.pub ~/backup/settings/ssh/</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>We have provided a single expression with the <code>-e</code> parameter. If you are providing a single expression only then this parameter is superfluous, but we will shortly add another expression.</p><p>This has changed all of the <code>cp</code> commands to <code>rmdir</code>. But did you notice the bug? It has also changed the letters <code>cp</code> in the comment which mentions <code>gcp</code> to <code>rmdir</code>, meaning our comment line has changed. I&#x27;ve made the changes bold to make this easier to see below:Before, it was:</p><pre tabindex="0" class="prism-code language-text codeBlockStandalone_csWH thin-scrollbar codeBlockContainer_I0IT theme-code-block" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"># Copy over alicloud, aws, azure, g<strong>cp</strong> and ssh config and credentials.</code></pre><p>Now it is:</p><pre tabindex="0" class="prism-code language-text codeBlockStandalone_csWH thin-scrollbar codeBlockContainer_I0IT theme-code-block" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"># Copy over alicloud, aws, azure, g<strong>rmdir</strong> and ssh config and credentials.</code></pre><p>This isn&#x27;t the worst bug in the world, but we can do better. Let&#x27;s change the expression to only run on lines which start with the letters <code>cp</code>:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ sed -e &#x27;/^cp/s/cp/rmdir/&#x27; backup-config.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#!/usr/bin/env bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Make sure we have a backup directory.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mkdir ~/backup</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Copy over alicloud, aws, azure, gcp and ssh config and credentials.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rmdir ~/.aliyun/config.json ~/backup/settings/aliyun/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rmdir ~/.aws/config ~/backup/settings/aws/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rmdir ~/.aws/credentials ~/backup/settings/aws/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rmdir ~/.azure/config ~/backup/settings/azure/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rmdir ~/.config/gcloud/credentials.db ~/backup/settings/gcloud/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rmdir ~/.ssh/config ~/backup/settings/ssh/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rmdir ~/.ssh/id_rsa ~/backup/settings/ssh/ # is this safe?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rmdir ~/.ssh/id_rsa.pub ~/backup/settings/ssh/</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Let&#x27;s look at the expression in detail. Before the <code>s</code> symbol, which indicates that we are performing a <em>substitution</em>, we now include a <em>line pattern</em>. A line pattern tells <code>sed</code> which lines it should apply the expression to. Our line pattern is just <code>^cp</code>, which is the regular expression meaning &quot;any line which starts with <code>cp</code>&quot;.</p><p>Line patterns can be quite sophisticated and are covered in the box later on in this chapter!</p><p>So all in all:</p><ul><li><code>^cp</code>- use the line pattern <code>^cp</code> (lines which start with <code>cp</code>) for the expression</li><li><code>s</code> - use the substitution function (which replaces text)</li><li><code>cp</code> - find the pattern <code>cp</code></li><li><code>rmdir</code> - replace each occurrence with <code>rmdir</code>
on lines which start with the text <code>cp</code>, replace any occurrences of the text text <code>cp</code> with the text <code>rmdir</code></li></ul><p>We combine these parts together using a <code>/</code> symbol, this is needed so that <code>sed</code> knows where the line pattern starts and end, the function starts and end and so on<sup id="fnref-2"><a href="#fn-2" class="footnote-ref">2</a></sup>.</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="removing-parts-of-a-line">Removing Parts of a Line<a class="hash-link" href="#removing-parts-of-a-line" title="Direct link to heading">â€‹</a></h4><p>Now we need to remove the first parameter for the <code>rmdir</code> command, it was used when we had <code>cp</code> as the command but doesn&#x27;t make sense any more.</p><p>Let&#x27;s apply a new expression:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ sed -E -e &#x27;/^cp/s/cp/rmdir/&#x27; -e &#x27;/^rmdir/s/~[^ ]+ //&#x27; backup-config.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#!/usr/bin/env bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Make sure we have a backup directory.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mkdir ~/backup</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Copy over alicloud, aws, azure, gcp and ssh config and credentials.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rmdir ~/backup/settings/aliyun/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rmdir ~/backup/settings/aws/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rmdir ~/backup/settings/aws/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rmdir ~/backup/settings/azure/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rmdir ~/backup/settings/gcloud/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rmdir ~/backup/settings/ssh/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rmdir ~/backup/settings/ssh/ # is this safe?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rmdir ~/backup/settings/ssh/</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Let&#x27;s take a look at the second expression, component by component:</p><ul><li><code>^rmdir</code> - use a line pattern which matches lines which start with <code>rmdir</code></li><li><code>s</code> - use the <em>substitution</em> function to replace text</li><li><code>~[^ ]+ </code> - search for the tilde <code>~</code> symbol and any non-space characters, up until the first space character</li></ul><p>We actually don&#x27;t even include a replacement - which is why the expression ends with <code>//</code> - the inside of the replacement part of the expression is empty. This means we search for a tilde <code>~</code>, match everything up until the next space <code> </code> and then replace it with nothing - meaning we remove it!</p><p>Note as well that we&#x27;ve used the <code>-E</code> flag to tell <code>sed</code> to use <em>extended regular expressions</em>. This allows us to use the <code>+</code> symbol without escaping it with a <code>\</code> first. In general I would recommend always using extended regular expressions as they are more commonly used and if you work with programming languages as well as the shell, those languages will likely use something closer to extended regular expressions rather than basic ones.</p><p>Let&#x27;s look at a few other ways to use <code>sed</code> for some real-world tasks.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="stripping-comments">Stripping Comments<a class="hash-link" href="#stripping-comments" title="Direct link to heading">â€‹</a></h3><p>In the script we&#x27;ve used above, there are some comments. Let&#x27;s use <code>sed</code> to remove them:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ sed -E &#x27;s/#.*$//&#x27; backup-config.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mkdir ~/backup</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cp ~/.aliyun/config.json ~/backup/settings/aliyun/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cp ~/.aws/config ~/backup/settings/aws/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cp ~/.aws/credentials ~/backup/settings/aws/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cp ~/.azure/config ~/backup/settings/azure/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cp ~/.config/gcloud/credentials.db ~/backup/settings/gcloud/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cp ~/.ssh/config ~/backup/settings/ssh/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cp ~/.ssh/id_rsa ~/backup/settings/ssh/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cp ~/.ssh/id_rsa.pub ~/backup/settings/ssh/</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Notice how we have removed the comments which started at the beginning of the file, as well as the comment after the <code>cp ~/.ssh/id_rsa</code> line. This is because the regular expression matches any hash symbol <code>#</code> and strips everything which follows it.</p><p>What about if we want to get rid of those empty lines? We can use the <code>d</code> or <em>delete</em> function:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ sed -E -e &#x27;s/#.*$//&#x27; -e &#x27;/^ *$/d&#x27; backup-config.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mkdir ~/backup</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cp ~/.aliyun/config.json ~/backup/settings/aliyun/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cp ~/.aws/config ~/backup/settings/aws/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cp ~/.aws/credentials ~/backup/settings/aws/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cp ~/.azure/config ~/backup/settings/azure/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cp ~/.config/gcloud/credentials.db ~/backup/settings/gcloud/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cp ~/.ssh/config ~/backup/settings/ssh/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cp ~/.ssh/id_rsa ~/backup/settings/ssh/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cp ~/.ssh/id_rsa.pub ~/backup/settings/ssh/</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>The delete command is applied to all lines which match the <em>line pattern</em>. In this case, the line pattern is a regular expression, <code>^ *$</code>, which matches any line made up only of space characters (including zero space characters, i.e. empty lines).</p><div class="admonition admonition-tip alert alert--success"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Line Patterns</h5></div><div class="admonition-content"><p>Line patterns, which can be used on many <code>sed</code> functions, are actually quite sophisticated. Here are a few examples:</p><ul><li><code>/test/</code> - any line matching the pattern <code>test</code></li><li><code>/test/!</code> - any line <em>not</em> matching <code>test</code></li><li><code>6</code> - line six</li><li><code>$</code> - the last line</li><li><code>1-10</code> - lines one to ten</li><li><code>1-10!</code> - lines <em>except _one</em> to ten</li></ul><p>Check <code>man sed</code> to see more about line patterns.</p></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="appending-text">Appending Text<a class="hash-link" href="#appending-text" title="Direct link to heading">â€‹</a></h3><p>In a regular expression the ampersand <code>$</code> symbol represents the end of a line.</p><p>We can use this symbol to add content to the end of lines - we just search for <code>$</code> and replace it with whatever we want to end the line with! And if we want to only do this on certain lines, we can use a line pattern to limit where we apply the expression.</p><p>Here&#x27;s how we can make sure that the <code>cp</code> command in the script doesn&#x27;t fail:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ sed -E -e &#x27;/^cp/s/$/ || true/&#x27; backup-config.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#!/usr/bin/env bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Make sure we have a backup directory.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mkdir ~/backup</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Copy over alicloud, aws, azure, gcp and ssh config and credentials.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cp ~/.aliyun/config.json ~/backup/settings/aliyun/ || true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cp ~/.aws/config ~/backup/settings/aws/ || true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cp ~/.aws/credentials ~/backup/settings/aws/ || true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cp ~/.azure/config ~/backup/settings/azure/ || true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cp ~/.config/gcloud/credentials.db ~/backup/settings/gcloud/ || true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cp ~/.ssh/config ~/backup/settings/ssh/ || true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cp ~/.ssh/id_rsa ~/backup/settings/ssh/ # is this safe? || true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cp ~/.ssh/id_rsa.pub ~/backup/settings/ssh/ || true</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Now we have a command which strips comments, deletes empty lines and then adds the text <code> || true</code> to the end of the line. This little trick ensures that the script won&#x27;t fail if one of the individual <code>cp</code> commands fails. We&#x27;ll see more about shell scripts later.</p><p>What if we want to add a semicolon to the end of all lines?</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">sed s/$/;/</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Easy!</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="prepending-text">Prepending Text<a class="hash-link" href="#prepending-text" title="Direct link to heading">â€‹</a></h3><p>In a regular expression the caret <code>^</code> symbol represents the start of a line.</p><p>We can apply the same trick as with the ampersand <code>$</code> symbol to add text to the start of a line - we just replace <code>^</code> with whatever we want the line to start with.</p><p>Here&#x27;s how we can use this trick!</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ sed -E -e &#x27;/^cp/s/$/&quot;/&#x27; -e &#x27;/&quot;$/s/^/echo &quot;/&#x27; backup-config.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#!/usr/bin/env bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Make sure we have a backup directory.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mkdir ~/backup</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Copy over alicloud, aws, azure, gcp and ssh config and credentials.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;cp ~/.aliyun/config.json ~/backup/settings/aliyun/&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;cp ~/.aws/config ~/backup/settings/aws/&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;cp ~/.aws/credentials ~/backup/settings/aws/&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;cp ~/.azure/config ~/backup/settings/azure/&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;cp ~/.config/gcloud/credentials.db ~/backup/settings/gcloud/&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;cp ~/.ssh/config ~/backup/settings/ssh/&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;cp ~/.ssh/id_rsa ~/backup/settings/ssh/ # is this safe?&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;cp ~/.ssh/id_rsa.pub ~/backup/settings/ssh/&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>We first put at quote at the end of each line which starts with <code>cp</code>, then put <code>echo &quot;</code> at the beginning of each line which ends with a quote!</p><p>This has now tweaked our script so that it doesn&#x27;t actually copy the files, it just prints out the commands to the screen. It also demonstrates how the order of the expressions is important, the second expression is applied after the first. If you are using multiple expressions be careful that an earlier expression doesn&#x27;t alter the line in a way which breaks the next expression!</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="extracting-information">Extracting Information<a class="hash-link" href="#extracting-information" title="Direct link to heading">â€‹</a></h3><p>What about if we want to <em>extract</em> some information from lines in a file?</p><p>Let&#x27;s take a quick look at our movies file in our data folder for reference:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ cd ~/effective-shell/data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ head -n 3 top100.csv</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;Rank&quot;,&quot;Rating&quot;,&quot;Title&quot;,&quot;Reviews&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;1&quot;,&quot;97&quot;,&quot;Black Panther (2018)&quot;,&quot;515&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;2&quot;,&quot;94&quot;,&quot;Avengers: Endgame (2019)&quot;,&quot;531&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>It should be easy to create a regular expression to find the year for each movie - it would just have to match all numeric values between brackets. Let&#x27;s try it out!</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ head -n 3 data/top100.csv | sed -E &#x27;s/.*\(([0-9]+)\).*/\1/&#x27; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;Rank&quot;,&quot;Rating&quot;,&quot;Title&quot;,&quot;Reviews&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2018</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2019</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>This works because we match any text, then capture any digits enclosed in brackets, then replace with the <code>\1</code> text, which means &#x27;the first match&#x27;.</p><p>Given what we know about <em>line patterns</em>, we can also easily exclude the first line:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ sed -E -e &#x27;1d&#x27; -e &#x27;s/.*\(([0-9]+)\).*/\1/&#x27; data/top100.csv </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2018</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2019</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Here we have just added the <code>1d</code> expression - delete the first line.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="advanced---surrounding-parts-of-text-with-quotes">Advanced - Surrounding Parts of Text with Quotes<a class="hash-link" href="#advanced---surrounding-parts-of-text-with-quotes" title="Direct link to heading">â€‹</a></h3><p>Let&#x27;s look at another example. Here we have some <code>yaml</code> content, a set of keys and values. Note that some of the values are quoted, and some are not:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">title: &quot;Advanced Text Manipulation&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">slug: advanced-text-manipulation</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">weight: 14</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>In fact this is the text content at the top of the file I am working on now. But this file is not a YAML file, it is a Markdown file (which is fairly close to plain text), so also has a lot of other content in it.</p><p>First, let&#x27;s see if we can extract the keys:</p><pre tabindex="0" class="prism-code language-text codeBlockStandalone_csWH thin-scrollbar codeBlockContainer_I0IT theme-code-block" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA">$ grep -E &#x27;[^:]+:&#x27; ~/effective-shell/docs/chapter12.md<strong>title</strong>: &quot;Advanced Text Manipulation&quot;<strong>slug</strong>: advanced-text-manipulation<strong>weight</strong>: 14<strong>Let&#x27;s say we have a script which is used to backup some local files to an Amazon S3 bucket. We can see a script like this here: We could use the `sed` command to change the S3 bucket. For example, if we wanted to change the `settings` text to `dotfiles` we could run the command below: Let&#x27;s look at the expression in detail:</strong>...snip...</code></pre><p>Well this kind of worked. The first three matches were correct, but we then found lots of other text. It looks like our pattern is not correct.</p><p>The pattern is <code>[^:]+:</code>, which means &#x27;at least one character which is <em>not</em> the <code>:</code> character, followed by <code>:</code>.</p><p>We can improve on it by telling it to not include spaces before the colon, and be explicit that this pattern we are searching for must be at the start of the line:</p><pre tabindex="0" class="prism-code language-text codeBlockStandalone_csWH thin-scrollbar codeBlockContainer_I0IT theme-code-block" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA">% grep -E &#x27;^[^: ]+:&#x27; ~/effective-shell/docs/chapter12.md<strong>title</strong>: &quot;Advanced Text Manipulation&quot;<strong>slug</strong>: advanced-text-manipulation<strong>weight</strong>: 14<strong>&quot;2&quot;,&quot;94&quot;,&quot;Avengers</strong>: Endgame (2019)&quot;,&quot;531&quot;</code></pre><p>Much better. The pattern now starts with <code>^</code> meaning &#x27;start of line&#x27;, and the type of characters we search for <code>[^: ]</code> is not &#x27;anything which is not a colon or space. But we&#x27;ve also found a film title from the text - we can improve our pattern further by eliminating quotes, which are not valid for YAML keys anyway:</p><pre tabindex="0" class="prism-code language-text codeBlockStandalone_csWH thin-scrollbar codeBlockContainer_I0IT theme-code-block" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA">$ grep -E &#x27;^[^: &quot;]+:&#x27; ~/effective-shell/docs/chapter12.md<strong>title</strong>: &quot;Advanced Text Manipulation&quot;<strong>slug</strong>: advanced-text-manipulation<strong>weight</strong>: 14</code></pre><p>Awesome!</p><div class="admonition admonition-tip alert alert--success"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Building Regular Expressions</h5></div><div class="admonition-content"><p>I was a hold out for years, but regular expressions are <em>incredibly useful</em> if you take the time to learn them. Exercises like this are a great way to do it. Start simple, add the elements you need bit by bit. It&#x27;s a great way to learn exactly what each element does.</p><p>Avoid just searching online for the perfect expression - they&#x27;ll often be very long (because they are bullet-proof and cover every possible edge case hopefully). If you are building an expression which is critical to get right, then do search online for help if you need it, but for day to day tasks, practicing like this will really help.</p></div></div><p>Now let&#x27;s start using this pattern in <code>sed</code>. Let&#x27;s print all lines which match the pattern:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ sed -E -n &#x27;/^[^: &quot;]+:/p&#x27; ~/effective-shell/docs/chapter12.md</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">title: &quot;Advanced Text Manipulation&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">slug: advanced-text-manipulation</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">weight: 14</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Now there are two critical things we&#x27;ve added to <code>sed</code> here while we&#x27;re working. The first is the <code>-n</code> flag, which means <em>no automatic printing</em> - meaning it will show no output unless told. Then in the pattern, we finish the command with <code>p</code>, meaning &#x27;print lines which match the pattern&#x27;.</p><p>These options make <code>sed</code> behave like <code>grep</code>, which is useful because we are still building the command.</p><p>Now let&#x27;s actually quote the result. To do that, we need to find lines where the <em>value</em> is not already quoted - so let&#x27;s add that to our pattern:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ sed -E -n &#x27;/^[^: &quot;]+: +[^&quot;]+$/p&#x27; ~/effective-shell/docs/chapter12.md</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">slug: advanced-text-manipulation</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">weight: 14</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Our pattern now reads like this:</p><ul><li><code>^[^ :&quot;]+:</code> - match the start of a line, any characters which are not space, colon or quote, which then finish with a colon and a space.</li><li><code> +[^&quot;]+$</code> - match at least one space, then any set of characters which don&#x27;t have a quote in them all the way to the end of the line.</li></ul><p>The pattern is working - its found our two unquoted keys. Now let&#x27;s get it to print the substitution.</p><p>First, we&#x27;re going to surround the key part and value part in brackets - this will make them &#x27;capture groups&#x27; - chunks of text we can use in the substitution. Here&#x27;s how capture groups work:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ sed -E -n &#x27;s/(^[^: &quot;]+:)( +[^&quot;]+$)/Key is &quot;\1&quot;/p&#x27; ~/effective-shell/docs/chapter12.md</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Key is &quot;slug:&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Key is &quot;weight:&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>We are now not just searching for a pattern, we&#x27;re using the <code>s</code> (<em>substitute</em>) function to replace all of the matched text with <code>Key is &quot;\1&quot;</code>. The <code>\1</code> just means &#x27;what you found in the first capture group&quot;.</p><p>We could just as easily show the value:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ sed -E -n &#x27;s/(^[^: &quot;]+:)( +[^&quot;]+$)/Value is &quot;\2&quot;/p&#x27; ~/effective-shell/docs/chapter12.md</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Value is &quot; advanced-text-manipulation&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Value is &quot; 14&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Here we&#x27;re printing the second capture group. Now you might have noticed that in the key, we&#x27;re including the colon, and in the value, we&#x27;re including the space (or spaces). This isn&#x27;t strictly right - they&#x27;re the separators. So let&#x27;s capture them separately:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ sed -E -n &#x27;s/(^[^: &quot;]+)(: +)([^&quot;]+$)/Key &quot;\1&quot;, Value &quot;\3&quot;, Separator &quot;\2&quot;/p&#x27; ~/effective-shell/docs/chapter12.md</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Key &quot;slug&quot;, Value &quot;advanced-text-manipulation&quot;, Separator &quot;: &quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Key &quot;weight&quot;, Value &quot;14&quot;, Separator &quot;: &quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>I think this is really starting to show just how powerful <code>sed</code> and regular expressions are.</p><p>Let&#x27;s finally tie it together - add quotes around unquoted values:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ sed -E -n &#x27;s/(^[^: &quot;]+)(: +)([^&quot;]+$)/\1\2&quot;\3&quot;/p&#x27; ~/effective-shell/docs/chapter12.md</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">slug: &quot;advanced-text-manipulation&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">weight: &quot;14&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Awesome!</p><p>If we wanted to actually change the file, we could remove the <code>-n</code> flag, so that we write out everything. This makes the <code>p</code> option at the end of the substitution superfluous:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ sed -E &#x27;s/(^[^: &quot;]+)(: +)([^&quot;]+$)/\1\2&quot;\3&quot;/&#x27; ~/effective-shell/docs/chapter12.md &gt; updated.md</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Let&#x27;s peep at the top of the file we created to see if it looks right:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ head -n 10 updated.md</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">title: &quot;Advanced Text Manipulation&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">slug: &quot;advanced-text-manipulation&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">weight: &quot;15&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Chapter 15 - Advanced Text Manipulation</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">In [Chapter 14](../../part-3-manipulating-text/slice-and-dice-text) we introduced some simple commands to work with text - specifically `head`, `tail`, `tr` and `cut`. Now we are going to take a look at how we can perform more sophisticated tasks with text.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Impressive - we&#x27;ve found a very specific pattern in a large file, substituted to match what we need and then saved the results.</p><p>This is just scratching the surface - but even with these basic tools, there is an incredible amount you can do. For example, what about if we didn&#x27;t want to quote values which are just numbers? We&#x27;d just change the pattern from:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ sed -E -n &#x27;/(^[^: &quot;]+:)( +[^&quot;0-9]+$)/p&#x27; ~/effective-shell/docs/chapter12.md</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">slug: advanced-text-manipulation</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>All we&#x27;ve done is changed the value pattern from <code>[^&quot;]</code> (anything except quotes) to <code>[^0-9]</code> (anything except quotes and digits).</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="advanced---template-files">Advanced - Template Files<a class="hash-link" href="#advanced---template-files" title="Direct link to heading">â€‹</a></h3><p>Here&#x27;s another example which I have found useful again and again. We can use <code>sed</code>&#x27;s text replacement capabilities to create a basic templating system.</p><p>For example, let&#x27;s say we have the file below:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Secret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: database-credentials</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  namespace: dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">stringData:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  username: admin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  password: ThisIsVerySensitive!</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>This the definition of a &#x27;secret&#x27; for Kubernetes. It doesn&#x27;t really matter how the file is structured because what we&#x27;ll do in this example could work for any file.</p><p>Let&#x27;s say we want to be able to <em>not</em> have the username and password stored in the file itself, because they are sensitive. We also want to make the &#x27;namespace&#x27; value configurable.</p><p>We can do this by putting some easy to find patterns as placeholders in the file, then replacing them at runtime when we need them with <code>sed</code>.</p><p>First, let&#x27;s create the &#x27;template&#x27; version of this file:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ cat &lt;&lt; EOF &gt; secret.template.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Secret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: database-credentials</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  namespace: %NAMESPACE%</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">stringData:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  username: %DB_USERNAME%</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  password: %DB_PASSWORD%</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>The first line is using a &#x27;heredoc&#x27; to write multiple lines of text to a file. We see heredocs in detail in a later chapter. The file is also in the samples at <code>effective-shell/templates/secret.template.yaml</code>.</p><p>Now let&#x27;s apply our substitution:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ sed -e &#x27;s/%NAMESPACE%/staging/&#x27; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -e &#x27;s/%DB_USERNAME%/admin/&#x27;          \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -e &#x27;s/%DB_PASSWORD%/secret/&#x27;     \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ~/effective-shell/templates/secret.template.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Secret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: database-credentials</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  namespace: staging</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">stringData:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  username: admin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  password: secret</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>I&#x27;ve used the <code>\</code> backslash character to split up the command into multiple lines. This command is really quite straightforward - we search for the very obvious to find patterns and replace them with values.</p><p>What if we wanted this to be dynamic, and instead of using hard-coded values get the values from environment variables? This is very straightforward:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ export NAMESPACE=production</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ export DB_USERNAME=prod-admin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ export DB_PASSWORD=Dhhs22kfid9c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ sed -e &quot;s/%NAMESPACE%/${NAMESPACE}/&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -e &quot;s/%DB_USERNAME%/${DB_USERNAME}/&quot;    \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -e &quot;s/%DB_PASSWORD%/${DB_PASSWORD}/&quot;  \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ~/effective-shell/templates/secret.template.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Secret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: database-credentials</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  namespace: production</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">stringData:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  username: prod-admin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  password: Dhhs22kfid9c</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>In fact, we could even take this a step further and simply replace <em>every</em> environment variable!</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">file_path=&quot;~/effective-shell/templates/secret.template.yaml&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">env_var_names=$(env | sed -E -n &#x27;s/^([^=]+)(=.*)/\1/p&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">for env_var_name in ${env_var_names}; do</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    echo &quot;Checking for &#x27;${env_var_name}&#x27;...&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if grep -q &quot;%${env_var_name}%&quot; &quot;${file_path}&quot;; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        echo &quot;-&gt; Found &#x27;${env_var_name}&#x27;, expanding now...&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env_var_value=&quot;${!env_var_name}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        escaped_env_var_value=$(echo ${env_var_value} | sed -e &#x27;s/[\/&amp;]/\\&amp;/g&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sed -e &quot;s/%${env_var_name}%/${escaped_env_var_value}/&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;${file_path}&quot; &gt; &quot;${file_path}.tmp&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mv &quot;${file_path}.tmp&quot; &quot;${file_path}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">done</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Now this might look like a lot at first, and to be fair it is! But almost everything here is actually using commands and concepts we&#x27;ve already seen.</p><p>Here&#x27;s what&#x27;s going on blow-by-blow:</p><ol><li><code>file_path</code> - we&#x27;re just creating a variable to hold the name of the file, this makes it easier to apply the command to other files</li><li><code>env_var_names=...</code> - we use <code>sed</code> to get the name of each environment variable. This comes from everything before the <code>=</code> sign in the output of the <code>env</code> command.</li><li><code>for ...</code> - this lets us &#x27;loop&#x27; through each environment variable name found - we&#x27;ll see more about this in the sections on scripting.</li><li><code>if grep -q</code> - check to see if the environment variable name is used in the file...</li><li>...and if it is, get the value of it with <code>${!env_var_name}</code> - the <code>!</code> exclamation mark is <em>variable indirection</em> and is Bash specific. It allows us to get the value of a variable which has a variable name</li><li><code>escaped_env_var_value</code> we need to replace some of the special characters which might be in the environment variable so that they don&#x27;t confuse <code>sed</code></li><li><code>sed -e</code> run the replacement, putting the results in a temporary file...</li><li>...replace the source file with the temporary one</li></ol><p>Many of these concepts, like <code>for</code> loops and variable indirection we will see in more detail later. But this little snippet really shows the power of Linux, the GNU tools and the shell - we can create sophisticated operations by composing together small and simple commands.</p><div class="admonition admonition-tip alert alert--success"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>A Note on Security</h5></div><div class="admonition-content"><p>It is very important to be careful when running commands like this or writing scripts which use this kind of pattern.</p><p>Allowing the contents of your environment variables to be put into files, or even the shell&#x27;s history can be a serious security concern.</p><p>As an example - note what would happen if we replaced <code>${DB_USERNAME}</code> with <code>${USERNAME}</code> in the script above? In <em>Z Shell</em> rather than the value we provided being put in the file, the <em>actual username of the user running the script</em> would be written (which in my case would be <code>dwmkerr</code>).</p><p>Be very careful when working with environment variables to make sure you avoid exposing private information. Even more sensitive variables might be things like <code>${AWS_SECRET_ACCESS_KEY}</code> - exposing variables like this could allow attackers to start accessing resources on your cloud environments.</p></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="what-about-in-place-editing">What About &#x27;In Place&#x27; Editing?<a class="hash-link" href="#what-about-in-place-editing" title="Direct link to heading">â€‹</a></h3><p>You might be aware that there is an &#x27;in-place&#x27; feature in <code>sed</code> which allows you to change the file you pass it directly. This allows you to do something like the below:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ sed -i &#x27;.bak&#x27; &#x27;s/staging/production/&#x27; test.txt</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>This would perform the substitutions and then put them in a file with <code>.bak</code> appended. To just overwrite the existing file, you could use:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ sed -i &#x27;&#x27; &#x27;s/staging/production/&#x27; test.txt</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>In this case we don&#x27;t append anything to the name of the overwritten file, so we end up replacing the original file itself.</p><p>How the <code>-i</code> flag works can vary on some systems so I generally prefer to simply output the result of <code>sed</code> to a new file and then replace the old one. However, it is useful to know what this flag is and how it is used, as you will often see it in examples.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="what-about-awk">What about Awk?<a class="hash-link" href="#what-about-awk" title="Direct link to heading">â€‹</a></h2><p>There is another very powerful text manipulation tool - <code>awk</code>. Often if you trying to find out how to perform more complex text based operations, you&#x27;ll see <code>awk</code> in the mix as a potential solution.</p><p>Awk is very sophisticated and has its own language to support complex transformations and operations. My advice is to first master <code>sed</code> and then consider learning <code>awk</code> if you regularly find yourself limited by <code>sed</code>.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="when-to-program">When to Program<a class="hash-link" href="#when-to-program" title="Direct link to heading">â€‹</a></h2><p>Personally, if I have tasks which are too complex for me to solve with the fairly basic knowledge of <code>sed</code> that I have, I will generally write a small program in Python, Node or another high-level and expressive language to do the work, and call that instead.</p><p>This will often be easier to maintain and understand than an extremely complex <code>sed</code> expression. But when you decide to move from a shell command to a programming language will be a decision which you will have to make on a case by case basis.</p><p>In a later chapter, we&#x27;ll look at how to write well-behaved command line programs which we can compose together using familiar mechanisms like pipelines to build more tools for our toolkit.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="summary">Summary<a class="hash-link" href="#summary" title="Direct link to heading">â€‹</a></h2><p>In this chapter we:</p><ul><li>Introduced <code>sed</code>, the stream editor command</li><li>Saw that when we need to transform or manipulate text, <code>sed</code> is often a great tool for the job</li><li>Learnt how to perform simple substitutions with <code>sed</code>, using commands such as <code>sed &#x27;s/old-text/new-text/&#x27;</code></li><li>Saw the components which make up a <code>sed</code> expression - the function, the expression and when needed, the line pattern</li><li>Saw how to use <code>-e</code> to apply multiple patterns</li><li>Went deeper into <em>extended regular expressions</em></li><li>Saw an example of how to strip comments from a file with <code>sed</code></li><li>Saw how to remove empty lines with <code>sed</code></li><li>Looked into <em>line patterns</em> in more detail, showing how we can choose what lines <code>sed</code> operates on</li><li>Saw how to append text to lines with <code>sed</code></li><li>Saw how to use patterns and capture groups to extract information from lines with <code>sed</code></li><li>Saw more advanced examples of capture groups, allowing us to capture different parts of a match and manipulate them individually, or recompose them</li><li>Saw how <code>sed</code> can be used to implement a simple &#x27;template&#x27; mechanism for files</li><li>Saw how the <code>-i</code> (<em>in place</em>) parameter works for <code>sed</code></li><li>Briefly described <code>awk</code> as a potential alternative tool to learn about for more sophisticated text manipulation</li><li>Suggested that if something is too complex to write easily in <code>sed</code>, it may be faster to implement it with a programming language</li></ul><div class="footnotes"><hr><ol><li id="fn-1">Note that if we used <code>rm -r</code> instead of <code>rmdir</code>, which is very common, we run the risk of making a big mistake - passing the source directory for the <code>cp</code> command as the first parameter to remove. This would mean we run <code>rm -r</code> on the source files for the backup and the backup folder itself, deleting both! This is one place where using <code>rmdir</code> makes a bit more sense - it won&#x27;t delete the source files if we make a mistake!<a href="#fnref-1" class="footnote-backref">â†©</a></li><li id="fn-2">You can use any character to delimit expressions - sometimes people will use <code>#</code> or <code>|</code> rather than a forward slash, typically because they want to use the forward slash as part of a pattern.<a href="#fnref-2" class="footnote-backref">â†©</a></li></ol></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/dwmkerr/dwmkerr/main/docs/03-manipulating-text/16-advanced-text-manipulation/index.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_dcUD" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_foO9"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/part-3-manipulating-text/slice-and-dice-text/"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Slice and Dice Text</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/part-3-manipulating-text/build-commands-on-the-fly/"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Build Commands on the Fly</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_cNA8 thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#introducing-the-stream-editor" class="table-of-contents__link toc-highlight">Introducing the Stream Editor</a></li><li><a href="#transformations-with-sed" class="table-of-contents__link toc-highlight">Transformations with Sed</a><ul><li><a href="#replacing-text" class="table-of-contents__link toc-highlight">Replacing Text</a></li><li><a href="#applying-multiple-expressions" class="table-of-contents__link toc-highlight">Applying Multiple Expressions</a></li><li><a href="#stripping-comments" class="table-of-contents__link toc-highlight">Stripping Comments</a></li><li><a href="#appending-text" class="table-of-contents__link toc-highlight">Appending Text</a></li><li><a href="#prepending-text" class="table-of-contents__link toc-highlight">Prepending Text</a></li><li><a href="#extracting-information" class="table-of-contents__link toc-highlight">Extracting Information</a></li><li><a href="#advanced---surrounding-parts-of-text-with-quotes" class="table-of-contents__link toc-highlight">Advanced - Surrounding Parts of Text with Quotes</a></li><li><a href="#advanced---template-files" class="table-of-contents__link toc-highlight">Advanced - Template Files</a></li><li><a href="#what-about-in-place-editing" class="table-of-contents__link toc-highlight">What About &#39;In Place&#39; Editing?</a></li></ul></li><li><a href="#what-about-awk" class="table-of-contents__link toc-highlight">What about Awk?</a></li><li><a href="#when-to-program" class="table-of-contents__link toc-highlight">When to Program</a></li><li><a href="#summary" class="table-of-contents__link toc-highlight">Summary</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Effective Shell</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/">Home</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/effective-shell" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://twitter.com/dwmkerr" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2022 Dave Kerr. Website built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.c9e750a8.js"></script>
<script src="/assets/js/main.feaa3aec.js"></script>
</body>
</html>